name: Deploy

on:
  push:
    branches: [main]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-Dwarnings"
  RUSTC_WRAPPER: sccache
  SCCACHE_GHA_ENABLED: "true"
  ENCRYPTION_KEY: "01234567890123456789012345678901"
  AWS_REGION: us-east-1

jobs:
  test:
    name: Rust CI
    uses: ./.github/workflows/rust-ci.yml

  e2e:
    name: E2E (Playwright)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.2

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          install-cargo-lambda: "true"
          use-sccache: "true"

      - name: Setup Node
        uses: ./.github/actions/setup-node
        with:
          lockfile-path: tests/e2e/pnpm-lock.yaml
          working-directory: tests/e2e

      - name: Install Playwright browser
        run: pnpm exec playwright install --with-deps chromium
        working-directory: tests/e2e

      - name: Run E2E tests
        run: pnpm test -- --forbid-only
        working-directory: tests/e2e

      - name: Upload Playwright artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v6.0.0
        with:
          name: playwright-artifacts-main
          path: |
            /tmp/ericauth-playwright-results
            tests/e2e/playwright-report
          if-no-files-found: ignore

  deploy-beta:
    name: Deploy to Beta
    needs: [test, e2e]
    runs-on: ubuntu-latest
    environment: beta
    outputs:
      api_url: ${{ steps.beta-output.outputs.api_url }}
    steps:
      - uses: actions/checkout@v6.0.2

      - name: Configure AWS credentials (Beta)
        uses: aws-actions/configure-aws-credentials@v6.0.0
        with:
          role-to-assume: ${{ vars.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          install-cargo-lambda: "true"
          use-sccache: "true"

      - name: Setup Node
        uses: ./.github/actions/setup-node
        with:
          lockfile-path: cdk/pnpm-lock.yaml
          working-directory: cdk

      - name: CDK Deploy (Beta)
        run: pnpm cdk deploy EricAuth-Beta --require-approval never --outputs-file cdk-outputs.json
        working-directory: cdk

      - name: Capture Beta API URL
        id: beta-output
        run: |
          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json
          with open("cdk/cdk-outputs.json", "r", encoding="utf-8") as f:
              outputs = json.load(f)
          print(f"api_url={outputs['EricAuth-Beta']['ApiUrl']}")
          PY

  e2e-beta:
    name: E2E (Beta)
    needs: deploy-beta
    runs-on: ubuntu-latest
    env:
      E2E_BASE_URL: ${{ needs.deploy-beta.outputs.api_url }}
    steps:
      - uses: actions/checkout@v6.0.2

      - name: Setup Node
        uses: ./.github/actions/setup-node
        with:
          lockfile-path: tests/e2e/pnpm-lock.yaml
          working-directory: tests/e2e

      - name: Install Playwright browser
        run: pnpm exec playwright install --with-deps chromium
        working-directory: tests/e2e

      - name: Run E2E tests against Beta
        run: pnpm test -- --forbid-only
        working-directory: tests/e2e

      - name: Upload Playwright artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v6.0.0
        with:
          name: playwright-artifacts-beta
          path: |
            /tmp/ericauth-playwright-results
            tests/e2e/playwright-report
          if-no-files-found: ignore

  deploy-prod:
    name: Deploy to Prod
    needs: [deploy-beta, e2e-beta]
    runs-on: ubuntu-latest
    environment: prod
    outputs:
      api_url: ${{ steps.prod-output.outputs.api_url }}
    steps:
      - uses: actions/checkout@v6.0.2

      - name: Configure AWS credentials (Prod)
        uses: aws-actions/configure-aws-credentials@v6.0.0
        with:
          role-to-assume: ${{ vars.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          install-cargo-lambda: "true"
          use-sccache: "true"

      - name: Setup Node
        uses: ./.github/actions/setup-node
        with:
          lockfile-path: cdk/pnpm-lock.yaml
          working-directory: cdk

      - name: CDK Deploy (Prod)
        run: pnpm cdk deploy EricAuth-Prod --require-approval never --outputs-file cdk-outputs.json
        working-directory: cdk

      - name: Capture Prod API URL
        id: prod-output
        run: |
          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json
          with open("cdk/cdk-outputs.json", "r", encoding="utf-8") as f:
              outputs = json.load(f)
          print(f"api_url={outputs['EricAuth-Prod']['ApiUrl']}")
          PY

  smoke-prod:
    name: Smoke (Prod)
    needs: deploy-prod
    runs-on: ubuntu-latest
    env:
      E2E_BASE_URL: ${{ needs.deploy-prod.outputs.api_url }}
    steps:
      - uses: actions/checkout@v6.0.2

      - name: Setup Node
        uses: ./.github/actions/setup-node
        with:
          lockfile-path: tests/e2e/pnpm-lock.yaml
          working-directory: tests/e2e

      - name: Install Playwright browser
        run: pnpm exec playwright install --with-deps chromium
        working-directory: tests/e2e

      - name: Run smoke tests against Prod
        run: pnpm test -- --forbid-only --grep @smoke
        working-directory: tests/e2e

      - name: Upload Playwright artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v6.0.0
        with:
          name: playwright-artifacts-prod
          path: |
            /tmp/ericauth-playwright-results
            tests/e2e/playwright-report
          if-no-files-found: ignore

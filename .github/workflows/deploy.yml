name: Deploy

on:
  push:
    branches: [main]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-Dwarnings"
  AWS_REGION: us-east-1

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo registry & build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Clippy
        run: cargo clippy --all-targets --all-features

      - name: Run tests
        run: cargo test --all-features
        env:
          ENCRYPTION_KEY: "01234567890123456789012345678901"

  e2e:
    name: E2E (Playwright)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-lambda
        run: pip install cargo-lambda

      - name: Cache cargo registry & build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-e2e-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-e2e-

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"
          cache-dependency-path: tests/e2e/pnpm-lock.yaml

      - name: Install E2E dependencies
        run: pnpm install --frozen-lockfile
        working-directory: tests/e2e

      - name: Install Playwright browser
        run: pnpm exec playwright install --with-deps chromium
        working-directory: tests/e2e

      - name: Run E2E tests
        run: pnpm test
        working-directory: tests/e2e

      - name: Upload Playwright artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts-main
          path: |
            /tmp/ericauth-playwright-results
            tests/e2e/playwright-report
          if-no-files-found: ignore

  deploy-beta:
    name: Deploy to Beta
    needs: [test, e2e]
    runs-on: ubuntu-latest
    environment: beta
    outputs:
      api_url: ${{ steps.beta-output.outputs.api_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (Beta)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-lambda
        run: pip install cargo-lambda

      - name: Cache cargo registry & build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-lambda-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-lambda-

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"
          cache-dependency-path: cdk/pnpm-lock.yaml

      - name: Install CDK dependencies
        run: pnpm install --frozen-lockfile
        working-directory: cdk

      - name: CDK Deploy (Beta)
        run: pnpm cdk deploy EricAuth-Beta --require-approval never --outputs-file cdk-outputs.json
        working-directory: cdk

      - name: Capture Beta API URL
        id: beta-output
        run: |
          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json
          with open("cdk/cdk-outputs.json", "r", encoding="utf-8") as f:
              outputs = json.load(f)
          print(f"api_url={outputs['EricAuth-Beta']['ApiUrl']}")
          PY

  e2e-beta:
    name: E2E (Beta)
    needs: deploy-beta
    runs-on: ubuntu-latest
    env:
      E2E_BASE_URL: ${{ needs.deploy-beta.outputs.api_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"
          cache-dependency-path: tests/e2e/pnpm-lock.yaml

      - name: Install E2E dependencies
        run: pnpm install --frozen-lockfile
        working-directory: tests/e2e

      - name: Install Playwright browser
        run: pnpm exec playwright install --with-deps chromium
        working-directory: tests/e2e

      - name: Run E2E tests against Beta
        run: pnpm test
        working-directory: tests/e2e

      - name: Upload Playwright artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts-beta
          path: |
            /tmp/ericauth-playwright-results
            tests/e2e/playwright-report
          if-no-files-found: ignore

  deploy-prod:
    name: Deploy to Prod
    needs: [deploy-beta, e2e-beta]
    runs-on: ubuntu-latest
    environment: prod
    outputs:
      api_url: ${{ steps.prod-output.outputs.api_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (Prod)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-lambda
        run: pip install cargo-lambda

      - name: Cache cargo registry & build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-lambda-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-lambda-

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"
          cache-dependency-path: cdk/pnpm-lock.yaml

      - name: Install CDK dependencies
        run: pnpm install --frozen-lockfile
        working-directory: cdk

      - name: CDK Deploy (Prod)
        run: pnpm cdk deploy EricAuth-Prod --require-approval never --outputs-file cdk-outputs.json
        working-directory: cdk

      - name: Capture Prod API URL
        id: prod-output
        run: |
          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json
          with open("cdk/cdk-outputs.json", "r", encoding="utf-8") as f:
              outputs = json.load(f)
          print(f"api_url={outputs['EricAuth-Prod']['ApiUrl']}")
          PY

  smoke-prod:
    name: Smoke (Prod)
    needs: deploy-prod
    runs-on: ubuntu-latest
    env:
      E2E_BASE_URL: ${{ needs.deploy-prod.outputs.api_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"
          cache-dependency-path: tests/e2e/pnpm-lock.yaml

      - name: Install E2E dependencies
        run: pnpm install --frozen-lockfile
        working-directory: tests/e2e

      - name: Install Playwright browser
        run: pnpm exec playwright install --with-deps chromium
        working-directory: tests/e2e

      - name: Run smoke tests against Prod
        run: pnpm test -- --grep @smoke
        working-directory: tests/e2e

      - name: Upload Playwright artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts-prod
          path: |
            /tmp/ericauth-playwright-results
            tests/e2e/playwright-report
          if-no-files-found: ignore

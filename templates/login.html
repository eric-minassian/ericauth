{% extends "base.html" %}

{% block title %}Log In â€” EricAuth{% endblock %}

{% block content %}
<h1>Log In</h1>

{% if let Some(err) = error %}
<div class="error-msg">{{ err }}</div>
{% endif %}

<form method="POST" action="/login">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <label for="email">Email</label>
    <input type="email" id="email" name="email" required autocomplete="email" {% if let Some(e) = email %}value="{{ e }}"{% endif %}>

    <div id="password-section">
        <label for="password">Password</label>
        <input type="password" id="password" name="password" required autocomplete="current-password">
    </div>

    {% if let Some(uri) = redirect_uri %}
    <input type="hidden" name="redirect_uri" value="{{ uri }}">
    {% endif %}
    {% if let Some(s) = state %}
    <input type="hidden" name="state" value="{{ s }}">
    {% endif %}
    {% if let Some(cid) = client_id %}
    <input type="hidden" name="client_id" value="{{ cid }}">
    {% endif %}
    {% if let Some(sc) = scope %}
    <input type="hidden" name="scope" value="{{ sc }}">
    {% endif %}
    {% if let Some(rt) = response_type %}
    <input type="hidden" name="response_type" value="{{ rt }}">
    {% endif %}
    {% if let Some(cc) = code_challenge %}
    <input type="hidden" name="code_challenge" value="{{ cc }}">
    {% endif %}
    {% if let Some(ccm) = code_challenge_method %}
    <input type="hidden" name="code_challenge_method" value="{{ ccm }}">
    {% endif %}
    {% if let Some(n) = nonce %}
    <input type="hidden" name="nonce" value="{{ n }}">
    {% endif %}

    <button type="button" id="continue-btn" class="btn btn-primary">Continue</button>
    <button type="submit" id="password-login-btn" class="btn btn-primary">Log In</button>
</form>

<button type="button" id="passkey-btn" class="btn btn-secondary" style="display:none;">Use a Passkey</button>

<div id="passkey-error" class="error-msg" style="display:none;"></div>

<div class="link-row">
    Don't have an account? <a href="/signup{% if !oauth_query.is_empty() %}?{{ oauth_query }}{% endif %}">Sign up</a>
</div>
<div class="link-row">
    <a href="/recover">Forgot your password?</a>
</div>

<script>
(function() {
    var hasPasskeySupport = !!window.PublicKeyCredential && !!(navigator.credentials && navigator.credentials.get);
    var form = document.querySelector('form[action="/login"]');
    var emailInput = document.getElementById('email');
    var passwordInput = document.getElementById('password');
    var passwordSection = document.getElementById('password-section');
    var continueBtn = document.getElementById('continue-btn');
    var passwordLoginBtn = document.getElementById('password-login-btn');
    var btn = document.getElementById('passkey-btn');
    var errEl = document.getElementById('passkey-error');

    function showPasswordFallback(message) {
        passwordSection.style.display = 'block';
        passwordLoginBtn.style.display = 'block';
        passwordInput.disabled = false;
        passwordInput.required = true;
        continueBtn.style.display = 'none';
        if (message) {
            errEl.textContent = message;
            errEl.style.display = 'block';
        }
        passwordInput.focus();
    }

    function hidePasswordFallback() {
        passwordSection.style.display = 'none';
        passwordLoginBtn.style.display = 'none';
        passwordInput.disabled = true;
        passwordInput.required = false;
    }

    hidePasswordFallback();

    function toBase64Url(buf) {
        var bytes = new Uint8Array(buf);
        var str = '';
        for (var i = 0; i < bytes.length; i++) str += String.fromCharCode(bytes[i]);
        return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    function fromBase64Url(s) {
        s = s.replace(/-/g, '+').replace(/_/g, '/');
        while (s.length % 4) s += '=';
        var bin = atob(s);
        var arr = new Uint8Array(bin.length);
        for (var i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
        return arr.buffer;
    }

    async function readResponseMessage(res, fallbackMessage) {
        var text = await res.text();
        if (!text) return fallbackMessage;
        try {
            var parsed = JSON.parse(text);
            if (parsed && typeof parsed.message === 'string' && parsed.message) {
                return parsed.message;
            }
        } catch (_) {
            // Keep original text fallback.
        }
        return text;
    }

    function isNoPasskeyFallbackError(message) {
        return message === 'No passkey found for this email. Enter your password to continue.';
    }

    async function beginPasskeyAuth(emailValue) {
        var authBody = { email: emailValue };
        var beginRes = await fetch('/passkeys/auth/begin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(authBody)
        });
        if (!beginRes.ok) {
            var beginErr = await readResponseMessage(beginRes, 'Failed to start passkey auth');
            if (beginRes.status === 401 && (beginErr === 'no passkeys registered' || beginErr === 'invalid email or passkey')) {
                throw new Error('No passkey found for this email. Enter your password to continue.');
            }
            throw new Error(beginErr || 'Failed to start passkey auth');
        }
        var beginData = await beginRes.json();

        var options = beginData.options;
        var allowCredentials = options.publicKey.allowCredentials || [];

        options.publicKey.challenge = fromBase64Url(options.publicKey.challenge);
        if (allowCredentials.length > 0) {
            options.publicKey.allowCredentials = allowCredentials.map(function(c) {
                return { id: fromBase64Url(c.id), type: c.type };
            });
        }

        if (options.mediation === 'conditional') {
            options.mediation = 'optional';
        }

        return {
            challengeId: beginData.challenge_id,
            options: options
        };
    }

    async function runPasskeyAuth(emailValue) {
        var beginData = await beginPasskeyAuth(emailValue);

        var credential = await navigator.credentials.get({
            publicKey: beginData.options.publicKey,
            mediation: beginData.options.mediation
        });
        if (!credential) throw new Error('Passkey authentication was cancelled');

        var body = {
            challenge_id: beginData.challengeId,
            credential: {
                id: credential.id,
                rawId: toBase64Url(credential.rawId),
                type: credential.type,
                response: {
                    authenticatorData: toBase64Url(credential.response.authenticatorData),
                    clientDataJSON: toBase64Url(credential.response.clientDataJSON),
                    signature: toBase64Url(credential.response.signature),
                    userHandle: credential.response.userHandle ? toBase64Url(credential.response.userHandle) : null
                }
            }
        };

        var completeRes = await fetch('/passkeys/auth/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        if (!completeRes.ok) {
            var completeErr = await readResponseMessage(completeRes, 'Passkey authentication failed');
            throw new Error(completeErr || 'Passkey authentication failed');
        }

        var oauthKeys = [
            'client_id',
            'redirect_uri',
            'response_type',
            'scope',
            'state',
            'code_challenge',
            'code_challenge_method',
            'nonce'
        ];
        var oauthParams = new URLSearchParams();
        for (var i = 0; i < oauthKeys.length; i++) {
            var key = oauthKeys[i];
            var input = document.querySelector('input[name="' + key + '"]');
            if (input && input.value) oauthParams.set(key, input.value);
        }

        if (oauthParams.get('client_id') && oauthParams.get('redirect_uri')) {
            window.location.href = '/authorize?' + oauthParams.toString();
        } else {
            window.location.href = '/account';
        }
    }

    continueBtn.addEventListener('click', async function() {
        errEl.style.display = 'none';
        var emailValue = emailInput && emailInput.value ? emailInput.value.trim() : '';
        if (!emailValue) {
            showPasswordFallback('Enter your email to continue.');
            return;
        }

        if (!hasPasskeySupport) {
            showPasswordFallback();
            return;
        }

        var originalText = continueBtn.textContent;
        continueBtn.disabled = true;
        continueBtn.textContent = 'Checking passkey...';
        try {
            btn.style.display = 'block';
            await runPasskeyAuth(emailValue);
        } catch (e) {
            var message = e && e.message ? e.message : '';
            if (isNoPasskeyFallbackError(message)) {
                showPasswordFallback();
            } else {
                showPasswordFallback(message || 'Passkey sign-in unavailable. Use your password.');
            }
        } finally {
            continueBtn.disabled = false;
            continueBtn.textContent = originalText;
        }
    });

    btn.addEventListener('click', async function() {
        errEl.style.display = 'none';
        var emailValue = emailInput && emailInput.value ? emailInput.value.trim() : '';
        if (!emailValue) {
            showPasswordFallback('Enter your email before using a passkey.');
            return;
        }

        var originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Waiting for passkey...';
        try {
            await runPasskeyAuth(emailValue);
        } catch (e) {
            var message = e && e.message ? e.message : '';
            if (!isNoPasskeyFallbackError(message)) {
                errEl.textContent = message || 'Passkey authentication failed';
                errEl.style.display = 'block';
            }
            showPasswordFallback();
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    });

    form.addEventListener('submit', function(e) {
        if (passwordLoginBtn.style.display === 'none') {
            e.preventDefault();
            continueBtn.click();
        }
    });

    emailInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && passwordLoginBtn.style.display === 'none') {
            e.preventDefault();
            continueBtn.click();
        }
    });
})();
</script>
{% endblock %}

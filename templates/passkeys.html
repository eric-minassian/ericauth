{% extends "base.html" %}

{% block title %}Manage Passkeys â€” EricAuth{% endblock %}

{% block content %}
<h1>Passkeys</h1>

{% if passkeys.is_empty() %}
<p class="passkey-empty">No passkeys registered yet.</p>
{% else %}
<ul class="passkey-list">
    {% for pk in &passkeys %}
    <li class="passkey-item">
        <div class="passkey-info">
            <strong>{{ pk.name }}</strong>
            <span class="passkey-date">Added {{ pk.created_at }}</span>
        </div>
        <form method="POST" action="/passkeys/delete" class="passkey-delete">
            <input type="hidden" name="credential_id" value="{{ pk.credential_id }}">
            <button type="submit" class="btn-small btn-danger">Remove</button>
        </form>
    </li>
    {% endfor %}
</ul>
{% endif %}

<button type="button" id="register-btn" class="btn btn-primary">Register New Passkey</button>

<div id="passkey-error" class="error-msg" style="display:none;"></div>
<div id="passkey-success" class="success-msg" style="display:none;"></div>

<script>
(function() {
    var btn = document.getElementById('register-btn');
    var errEl = document.getElementById('passkey-error');
    var successEl = document.getElementById('passkey-success');

    if (!window.PublicKeyCredential) {
        btn.disabled = true;
        btn.textContent = 'Passkeys not supported in this browser';
        return;
    }

    function toBase64Url(buf) {
        var bytes = new Uint8Array(buf);
        var str = '';
        for (var i = 0; i < bytes.length; i++) str += String.fromCharCode(bytes[i]);
        return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    function fromBase64Url(s) {
        s = s.replace(/-/g, '+').replace(/_/g, '/');
        while (s.length % 4) s += '=';
        var bin = atob(s);
        var arr = new Uint8Array(bin.length);
        for (var i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
        return arr.buffer;
    }

    btn.addEventListener('click', async function() {
        errEl.style.display = 'none';
        successEl.style.display = 'none';
        try {
            var beginRes = await fetch('/passkeys/register/begin', { method: 'POST' });
            if (!beginRes.ok) throw new Error('Failed to start registration');
            var beginData = await beginRes.json();

            var options = beginData.options;
            options.publicKey.challenge = fromBase64Url(options.publicKey.challenge);
            options.publicKey.user.id = fromBase64Url(options.publicKey.user.id);
            if (options.publicKey.excludeCredentials) {
                options.publicKey.excludeCredentials = options.publicKey.excludeCredentials.map(function(c) {
                    return { id: fromBase64Url(c.id), type: c.type };
                });
            }

            var credential = await navigator.credentials.create(options);

            var body = {
                challenge_id: beginData.challenge_id,
                credential: {
                    id: credential.id,
                    rawId: toBase64Url(credential.rawId),
                    type: credential.type,
                    response: {
                        attestationObject: toBase64Url(credential.response.attestationObject),
                        clientDataJSON: toBase64Url(credential.response.clientDataJSON)
                    }
                }
            };

            var completeRes = await fetch('/passkeys/register/complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (!completeRes.ok) throw new Error('Registration failed');

            successEl.textContent = 'Passkey registered successfully!';
            successEl.style.display = 'block';
            setTimeout(function() { window.location.reload(); }, 1000);
        } catch (e) {
            errEl.textContent = e.message || 'Passkey registration failed';
            errEl.style.display = 'block';
        }
    });
})();
</script>
{% endblock %}

{% block head %}
<style>
    .passkey-empty { color: #666; margin-bottom: 1rem; }
    .passkey-list { list-style: none; margin-bottom: 1.5rem; }
    .passkey-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #e5e7eb;
    }
    .passkey-info { display: flex; flex-direction: column; }
    .passkey-date { font-size: 0.75rem; color: #999; }
    .passkey-delete { margin: 0; }
    .btn-small {
        padding: 0.25rem 0.75rem;
        font-size: 0.8rem;
        width: auto;
    }
</style>
{% endblock %}
